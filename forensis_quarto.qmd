---
title: "Forensis Dokument"
format: 
  html:
    self-contained: true
---

```{r setup, include=FALSE}

library(shiny)
library(bslib)
library(DT)
library(httr)
library(jsonlite)
library(data.table)
library(shinydashboard)
library(mongolite)
library(shinycssloaders) # ovo je za spinera kod pretraživanja / maknuti ?
library(quarto)
library(RMySQL)
library(stringr)


# Učitavanje zasebnih skripti
source("functions.R")

```


```{r, echo = FALSE}
# Primjer OIB-a za pretragu
oib <- "62694367015"

# Učitajte podatke iz zemljišnih knjiga prema OIB-u
zkrh_data <- zkrh(oib, part = 0)
if (nrow(zkrh_data) == 0) {
  final_data <- data.table()
} else {
  # Dohvaćanje dokumenata iz MongoDB-a
  mongo_data <- mongoDB(zkrh_data$id, collection = collection_name, db = db_name, url = db_url)

  # Spajanje podataka
  final_data <- spoji_podatke(zkrh_data, mongo_data)

  # Ažuriranje URL-a
  base_url <- "https://oss.uredjenazemlja.hr/oss/public/reports/ldb-extract/"
  final_data[, fileUrl := ifelse(is.na(fileUrl), NA_character_, paste0(base_url, fileUrl))]

  # Odabir potrebnih varijabli i promjena imena stupaca
  final_data <- final_data[, .(id, type, unit, institution, book, status, burden, fileUrl)]
  setnames(final_data, old = c("id", "type", "unit", "institution", "book", "status", "burden", "fileUrl"),
           new = c("ID", "Vrsta knjige", "Broj zemljišta (kat. čestice)", "Općinski sud / ZK odjel", "Glavna knjiga", "Status", "Teret", "Link"))
}

# Prikaz rezultata
datatable(final_data, escape = FALSE, options = list(
  pageLength = 5,
  columnDefs = list(
    list(
      targets = ncol(final_data),  # Indeks stupca 'Link'
      render = JS(
        "function(data, type, row, meta) {",
        "return type === 'display' && data ? '<a href=\"' + data + '\" target=\"_blank\">Open</a>' : data;",
        "}"
      )
    )
  )
))


```

