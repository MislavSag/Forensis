---
title: "Forensis dokument - Pravne Osobe"
format: 
  html:
    theme: "cosmo"
    highlight-style: "github"
    toc: true
    toc-depth: 2
    self-contained: true
params:
  oib: "12028724450" # YAML file pregazi ovaj broj u app ##02573674713
---

```{r setup, include=FALSE}
library(shiny)
library(bslib)
library(DT)
library(httr)
library(jsonlite)
library(data.table)
library(mongolite)
library(shinycssloaders)
library(quarto)
library(RMySQL)
library(stringr)

# Učitavanje zasebnih skripti
source("functions.R")

# print(Sys.getenv("SUDREG_API_USER"))

# Postavljanje globalnih opcija za prikaz koda i upozorenja
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

# parametar 'oib' iz Quarto dokumenta
oib <- params$oib

# ove funkcjije vuku podatke - definirane su u skripti functions
data <- pravne_osobe_API(oib)
tablice <- prikazi_podatke_pravne_osobe(data)

# naziv ću spremiti kao skraćenu tvrtku
naziv <- tablice$skracena_tvrtka$Skracena_Tvrtka[1]
```

Prikazuju se podaci za: **OIB: `r params$oib`**.
Koristi se skraćeni naziv tvrtke: **`r naziv`**.

U nastavku su prikazani: detaljni podaci sa sudskog registra za pravnu osobu; podaci iz zemljišnih knjiga RH, Republike Srpske i Federacije; baza plovila RH.

## Opći podaci - Sudski registar

```{r opci_podaci}
if (!is.null(tablice$opci_podaci)) {
  datatable(tablice$opci_podaci, options = list(pageLength = 25, dom = 't', paging = FALSE), rownames = FALSE)
}
```

## Tvrtka

```{r tvrtka}
if (!is.null(tablice$tvrtka)) {
  datatable(tablice$tvrtka, options = list(pageLength = 5, dom = 't', paging = FALSE), rownames = FALSE)
}
```

## Skraćena tvrtka

```{r skracena tvrtka}
if (!is.null(tablice$skracena_tvrtka)) {
  datatable(tablice$skracena_tvrtka, options = list(pageLength = 5, dom = 't', paging = FALSE), rownames = FALSE)
}
```

## Sjedište

```{r sjediste}
if (!is.null(tablice$sjediste)) {
  datatable(tablice$sjediste, options = list(pageLength = 5, dom = 't', paging = FALSE), rownames = FALSE)
}
```

## Email adrese

```{r email}
if (!is.null(tablice$email_adrese)) {
  datatable(tablice$email_adrese, options = list(pageLength = 5, dom = 't', paging = FALSE), rownames = FALSE)
}
```

## Predmet poslovanja

```{r poslovanje}
if (!is.null(tablice$predmeti_poslovanja)) {
  if (is.data.frame(tablice$predmeti_poslovanja$nacionalna_klasifikacija_djelatnosti)) {
    # Ako je 'nacionalna_klasifikacija_djelatnosti' data frame, kombiniramo relevantne stupce
    df <- data.frame(
      Djelatnost_RBR = tablice$predmeti_poslovanja$djelatnost_rbr,
      NKD_Puni_Naziv = tablice$predmeti_poslovanja$nacionalna_klasifikacija_djelatnosti$puni_naziv
    )
    datatable(df, options = list(pageLength = 5), caption = "Predmeti poslovanja s NKD")
  } else {
    # Ako 'nacionalna_klasifikacija_djelatnosti' nije data frame, prikazujemo cijelu tablicu
    datatable(tablice$predmeti_poslovanja, options = list(pageLength = 15), rownames = FALSE)
  }
}

```

## Temeljni kapital

```{r}
if (!is.null(tablice$temeljni_kapitali)) {
  datatable(tablice$temeljni_kapitali, options = list(pageLength = 5, dom = 't', paging = FALSE), rownames = FALSE)
}
```

## GFI

```{r}
if (!is.null(tablice$gfi)) {
  datatable(tablice$gfi, options = list(pageLength = 10, dom = 't', paging = FALSE), rownames = FALSE)
}
```

## Promjene

```{r}
if (!is.null(tablice$promjene)) {
  datatable(tablice$promjene, options = list(pageLength = 10, dom = 't', paging = FALSE), rownames = FALSE)
}
```


## Zemljišne knjige RH po oib-u
```{r zkrh oib}

# Učitajte podatke iz zemljišnih knjiga prema OIB-u
zkrh_data <- zkrh(oib, part = 0)
if (nrow(zkrh_data) == 0) {
  cat(paste("Nema rezultata u zemljišnim knjigama"))
} else {
  # Dohvaćanje dokumenata iz MongoDB-a
  mongo_data <- mongoDB(zkrh_data$id, collection = collection_name, db = db_name, url = db_url)

  # Spajanje podataka
  final_data <- spoji_podatke(zkrh_data, mongo_data)

  # Ažuriranje URL-a
  base_url <- "https://oss.uredjenazemlja.hr/oss/public/reports/ldb-extract/"
  final_data[, fileUrl := ifelse(is.na(fileUrl), NA_character_, paste0(base_url, fileUrl))]

  # Odabir potrebnih varijabli i promjena imena stupaca
  final_data <- final_data[, .(id, type, unit, institution, book, status, burden, fileUrl)]
  setnames(final_data, old = c("id", "type", "unit", "institution", "book", "status", "burden", "fileUrl"),
           new = c("ID", "Vrsta knjige", "Broj zemljišta (kat. čestice)", "Općinski sud / ZK odjel", "Glavna knjiga", "Status", "Teret", "Link"))

  # Prikaz rezultata koristeći funkciju DT_template_ZKRH
  DT_template_ZKRH(final_data, fixedHeader = FALSE)
}
```

## Zemljišne knjige RH po nazivu
```{r zkrh naziv}

# Učitajte podatke iz zemljišnih knjiga prema OIB-u
zkrh_data <- zkrh(naziv, part = 0)
if (nrow(zkrh_data) == 0) {
  cat(paste("Nema rezultata u zemljišnim knjigama"))
} else {
  # Dohvaćanje dokumenata iz MongoDB-a
  mongo_data <- mongoDB(zkrh_data$id, collection = collection_name, db = db_name, url = db_url)

  # Spajanje podataka
  final_data <- spoji_podatke(zkrh_data, mongo_data)

  # Ažuriranje URL-a
  base_url <- "https://oss.uredjenazemlja.hr/oss/public/reports/ldb-extract/"
  final_data[, fileUrl := ifelse(is.na(fileUrl), NA_character_, paste0(base_url, fileUrl))]

  # Odabir potrebnih varijabli i promjena imena stupaca
  final_data <- final_data[, .(id, type, unit, institution, book, status, burden, fileUrl)]
  setnames(final_data, old = c("id", "type", "unit", "institution", "book", "status", "burden", "fileUrl"),
           new = c("ID", "Vrsta knjige", "Broj zemljišta (kat. čestice)", "Općinski sud / ZK odjel", "Glavna knjiga", "Status", "Teret", "Link"))

  # Prikaz rezultata koristeći funkciju DT_template_ZKRH
  DT_template_ZKRH(final_data, fixedHeader = FALSE)
}

```

## Plovila RH po nazivu
```{r plovila naziv}

# Dohvaćanje rezultata pretrage iz baze podataka za plovila
plovila_data <- loadData_plovila(naziv)
if (nrow(plovila_data) == 0) {
  cat(paste("Nema rezultata u registru plovila."))
} else {
  final_plovila <- plovila_data
  # Prikaz rezultata koristeći funkciju DT_template_ZKBIH_plovila
  DT_template_ZKBIH_plovila(zkrs_data, fixedHeader = FALSE)
}

```

## Zemljišne knjige RS po nazivu
```{r zkrs naziv}

# Dohvaćanje rezultata pretrage iz baze podataka za zemljišne knjige RS
zkrs_data <- zkrs(naziv = naziv)
if (nrow(zkrs_data) == 0) {
  cat(paste("Nema rezultata pretrage u zemljišnim knjigama RS"))
} else {
  # Prikaz rezultata koristeći funkciju DT_template_ZKBIH_plovila
  DT_template_ZKBIH_plovila(zkrs_data, fixedHeader = FALSE)
}
```

## Zemljišne knjige Federacija po nazivu
```{r zkF naziv}

# Dohvaćanje rezultata pretrage iz baze podataka za zemljišne knjige Federacija
zkrs_data <- zkrs(naziv = naziv, table = "zk_f_vlasnici")
if (nrow(zkrs_data) == 0) {
  cat(paste("Nema rezultata pretrage u zemljišnim knjigama RS"))
} else {
  # Prikaz rezultata koristeći funkciju DT_template_ZKBIH_plovila
  DT_template_ZKBIH_plovila(zkrs_data, fixedHeader = FALSE)
}
```
